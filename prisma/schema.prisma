generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id           String           @id @default(uuid())
  pId          Int              @unique
  name         String
  kana         String
  birthDate    DateTime?
  phone        String?
  gender       String?
  address      String?
  memo         String?
  tags         String           @default("[]")
  attributes   String           @default("{}")
  externalRef  String           @default("{}")
  importMeta   String           @default("{}")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  deletedAt    DateTime?
  appointments Appointment[]
  attachments  Attachment[]
  records      ClinicalRecord[]

  @@index([kana])
  @@index([phone])
}

model ClinicalRecord {
  id          String       @id @default(uuid())
  patientId   String
  visitDate   DateTime     @default(now())
  visitCount  Int          @default(1)
  subjective  String       @default("")
  objective   String       @default("")
  assessment  String       @default("")
  plan        String       @default("")
  rawText     String?      @default("")
  tags        String       @default("[]")
  metadata    String       @default("{}")
  staffId     String
  createdBy   String?
  updatedBy   String?
  revision    Int          @default(1)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attachments Attachment[]
  patient     Patient      @relation(fields: [patientId], references: [id])
  staff       Staff        @relation(fields: [staffId], references: [id])

  @@index([patientId, visitDate])
  @@index([visitDate])
}

model Attachment {
  id         String          @id @default(uuid())
  patientId  String
  recordId   String?
  fileType   String
  storageKey String
  ocrText    String?         @default("")
  createdAt  DateTime        @default(now())
  patient    Patient         @relation(fields: [patientId], references: [id])
  record     ClinicalRecord? @relation(fields: [recordId], references: [id])
}

model Appointment {
  id                  String    @id @default(uuid())
  patientId           String
  startAt             DateTime
  duration            Int       @default(30)
  status              String    @default("scheduled")
  arrivedAt           DateTime?
  memo                String?
  adminMemo           String?
  isMemoResolved      Boolean   @default(false)
  staffId             String?
  createdBy           String?
  updatedBy           String?
  adminMemoResolvedBy String?
  adminMemoResolvedAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  patient             Patient   @relation(fields: [patientId], references: [id])
  staff               Staff?    @relation(fields: [staffId], references: [id])

  @@index([startAt, status])
  @@index([patientId, startAt])
}

model Staff {
  id           String           @id @default(uuid())
  name         String
  role         String           @default("Director")
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  loginId      String?          @unique
  passwordHash String?
  appointments Appointment[]
  records      ClinicalRecord[]
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}
