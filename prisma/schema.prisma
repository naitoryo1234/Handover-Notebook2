generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Patient {
  id           String           @id @default(uuid())
  pId          Int              @unique
  name         String
  kana         String
  birthDate    DateTime?
  phone        String?
  gender       String?
  address      String?
  memo         String?
  tags         String           @default("[]")
  attributes   String           @default("{}")
  externalRef  String           @default("{}")
  importMeta   String           @default("{}")
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  deletedAt    DateTime?
  appointments Appointment[]
  attachments  Attachment[]
  records      ClinicalRecord[]

  @@index([kana])
  @@index([phone])
}

model ClinicalRecord {
  id          String       @id @default(uuid())
  patientId   String
  visitDate   DateTime     @default(now())
  visitCount  Int          @default(1)
  subjective  String       @default("")
  objective   String       @default("")
  assessment  String       @default("")
  plan        String       @default("")
  rawText     String?      @default("")
  tags        String       @default("[]")
  metadata    String       @default("{}")
  staffId     String
  createdBy   String?
  updatedBy   String?
  revision    Int          @default(1)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  attachments Attachment[]
  patient     Patient      @relation(fields: [patientId], references: [id])
  staff       Staff        @relation(fields: [staffId], references: [id])

  @@index([patientId, visitDate])
  @@index([visitDate])
}

model Attachment {
  id         String          @id @default(uuid())
  patientId  String
  recordId   String?
  fileType   String
  storageKey String
  ocrText    String?         @default("")
  createdAt  DateTime        @default(now())
  patient    Patient         @relation(fields: [patientId], references: [id])
  record     ClinicalRecord? @relation(fields: [recordId], references: [id])
}

model Appointment {
  id                  String    @id @default(uuid())
  patientId           String
  startAt             DateTime
  duration            Int       @default(30)
  status              String    @default("scheduled")
  arrivedAt           DateTime?
  memo                String?
  adminMemo           String?
  isMemoResolved      Boolean   @default(false)
  staffId             String?
  createdBy           String?
  updatedBy           String?
  adminMemoResolvedBy String?
  adminMemoResolvedAt DateTime?
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  patient             Patient   @relation(fields: [patientId], references: [id])
  staff               Staff?    @relation(fields: [staffId], references: [id])

  @@index([startAt, status])
  @@index([patientId, startAt])
}

model Staff {
  id           String           @id @default(uuid())
  name         String
  role         String           @default("Director")
  active       Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  loginId      String?          @unique
  passwordHash String?
  appointments Appointment[]
  records      ClinicalRecord[]
}

model SystemSetting {
  key         String   @id
  value       String
  description String?
  updatedAt   DateTime @updatedAt
}

// =====================================================
// LINE Integration Module (Optional Feature)
// =====================================================

/// LINE公式アカウントのAPI認証情報（テナントごと）
model LineChannel {
  id                 String        @id @default(uuid())
  name               String        // 表示名（例: 「○○院 予約通知」）
  channelId          String        @unique // LINE Channel ID
  channelSecret      String        // Webhook署名検証用
  channelAccessToken String        // メッセージ送受信用
  webhookUrl         String?       // 設定されたWebhook URL
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  messages           LineMessage[]
  linkRequests       LineLinkRequest[]
}

/// LINEメッセージ送受信履歴
model LineMessage {
  id          String      @id @default(uuid())
  channelId   String      // どのチャンネル経由か
  patientId   String?     // 紐付け済みの場合
  lineUserId  String      // LINE User ID
  direction   String      // "incoming" | "outgoing"
  messageType String      // "text" | "image" | "sticker" | etc.
  content     String      // テキスト内容または参照情報
  rawPayload  String      @default("{}") // LINE APIの生レスポンス
  status      String      @default("sent") // "sent" | "delivered" | "read" | "failed"
  sentAt      DateTime    @default(now())
  createdAt   DateTime    @default(now())

  channel     LineChannel @relation(fields: [channelId], references: [id])

  @@index([channelId, sentAt])
  @@index([lineUserId])
}

/// 顧客とLINE User IDの紐付けリクエスト（一時トークン）
model LineLinkRequest {
  id        String      @id @default(uuid())
  channelId String      // どのチャンネル用か
  patientId String      // 紐付け対象の顧客
  token     String      @unique // ランダム生成されたリンクトークン
  expiresAt DateTime    // 有効期限（24時間など）
  createdAt DateTime    @default(now())

  channel   LineChannel @relation(fields: [channelId], references: [id])

  @@index([patientId])
}

