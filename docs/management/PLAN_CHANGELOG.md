# Plan Changelog

プロジェクトの計画変更・実装履歴を記録します。

---

## v2.9.0 (2025-12-19)

### 変更内容

- **クイック記録機能（Customer Notebook）**
  - 顧客一覧ページに「クイック記録」ボタン追加
  - 音声入力 → AI顧客名抽出 → 顧客マッチング → 確認 → 保存の全フロー実装
  - `QuickRecordModal.tsx` 新規作成
  - `CustomerNotebookToolbar.tsx` 新規作成
  - 確認画面で記録内容を編集可能に
  - 複数候補時に直近来店日で区別可能なUI

- **AI整形プロンプト強化**
  - 鍼灸院デモ向けに`geminiActions.ts`を最適化
  - 抽出項目拡充: body_parts（施術部位）, next_visit（次回来院）, cautions（禁忌事項）
  - Few-shot例追加（禁忌ありケース）
  - 【重要（禁忌事項）】形式での強調出力

- **PC版音声コマンド対応（Reservation V2）**
  - `ReservationToolbar.tsx`にPC版マイクボタン追加
  - 検索バー横に配置、モバイル版と同じ`parseVoiceCommand`連携

- **音声コマンドバグ修正**
  - `applyVoiceCommand`の冒頭で全フィルターをクリアするよう修正
  - 連続で音声入力しても前回の条件が残らない

- **顧客選択UI改善**
  - `searchPatientsForSelect`に`lastVisit`と`lastVisitType`を追加
  - 同姓顧客の区別のため直近来店日を表示
  - 予約（📅）/記録（📄）アイコンで来店種別を表示

- **ドキュメント**
  - `docs/management/IDEAS.md`: 業態プリセット対応、音声入力PRDの必要性を記録
  - `docs/demo/VOICE_INPUT_TEST_SCRIPT.md`: 音声入力テスト台本作成

### 変更の背景
- 「今日来た山田さんは...」と話すだけで、顧客ページに行かずにメモを追加できる「クイック記録」機能を実装
- 同姓の顧客がいる場合でも、直近来店日で区別できるように改善
- AIプロンプトと入力フォームの連携は将来のPRD作成項目として記録

---

## v2.8.0 (2025-12-19)

### 変更内容

- **音声コマンド機能拡張**
  - **スタッフ指定対応**: 「田中先生の予約」→ staffIdフィルター
  - **時間帯フィルター**: 「午前中」「午後」「夕方」「夜」→ timeRangeフィルター
  - **具体的時刻指定**: 「17時以降」「18時周辺」→ afterHour/aroundHourフィルター
  - Geminiプロンプト改善: Few-shot例追加、キーワード拡充
  - フォールバック処理強化: 正規表現パターンを拡充

- **SearchStatusBar拡張**
  - 時間フィルター条件のチップ表示追加
  - 「🕐 18時周辺 (17:00-19:59)」のような具体的な時間範囲表示
  - 個別フィルター解除機能

- **UI修正**
  - 申し送りフィルターのanimate-pulse滲み問題を修正
  - アニメーションをアイコンのみに適用するよう変更

- **サンプルデータ追加スクリプト**
  - `prisma/add-future-appointments.ts` 作成
  - 今日から2週間分の予約データを自動生成
  - 本番環境（Neon）にも適用

### 変更の背景
- 「何月何日の18時周辺の予約って空いてたっけ」のような実運用ユースケースに対応
- フィルター条件の可視化により、ユーザーが現在の表示状態を把握しやすくなった
- 音声コマンドの解析精度向上と複合条件対応

---

## v2.7.0 (2025-12-19)

### 変更内容

- **MobileVoiceInput Portal修正**
  - React Portal導入でモーダルを`body`直下にレンダリング
  - z-indexを100に引き上げ、`lg:hidden`を削除
  - モバイル画面でのモーダル表示問題を解決

- **音声コマンドAI意図解析 (Voice Command Parsing)**
  - `voiceCommandActions.ts` 新規作成（Gemini API統合）
  - 音声入力 → Whisper文字起こし → Gemini意図解析 → フィルター自動適用
  - 対応パターン:
    - 名前検索: 「加藤さん」→「加藤」で検索（敬称自動除去）
    - 日付フィルター: 「今日」「明日」「来週」「1月15日」など
    - 期間指定: 「全部」「一覧」「全期間」
    - 担当未定フィルター: 「担当未定」「未割り当て」「担当者なし」
    - 申し送りフィルター: 「申し送り」「メモあり」「引き継ぎ」
  - フォールバック処理（正規表現ベース）も実装

- **ReservationV2Client拡張**
  - `applyVoiceCommand` 関数追加
  - 音声コマンド結果に基づくフィルター一括適用
  - Toastによる操作フィードバック表示

- **UIテキスト修正**
  - ツールバーの「送」→「申し送り」に変更
  - 検索条件バーの「送りのみ」→「申し送り」に変更

- **Vercelビルドエラー修正**
  - `ReservationNotebookClient.tsx`のFormDataEntryValue型エラーを修正

### 変更の背景
- 音声入力は本システムの「キラー機能」として位置付け
- 現場での高速オペレーションを実現するため、自然言語コマンドによるフィルタリングを導入
- 「担当未定の一覧を見たい」のような複合的な発話にも対応

---

## v1.0.0 (2024-12-16)

### 変更内容
- **Business Notebook 分離実装完了**
  - CRMから Customer Notebook / Reservation Notebook を分離
  - 共通顧客マスタ方式を採用（パターンA）
  - トップページ: 顧客一覧 + Notebook選択カード
  - Customer Notebook: 顧客検索 + Pinned Note 編集
  - Reservation Notebook: 今日の予約一覧 + CRUD
  - 顧客登録ページ: /customers/new

- **削除した機能**
  - カルテ詳細（SOAP）
  - スタッフ管理
  - 設定画面
  - 認証機能
  - CRMダッシュボード

### 変更の背景
- 「1つのCRMを再構築しない」「2つの小さな業務ツールを並べる」という方針
- 単体でも使える、必要なら連携もできる設計思想
- 土曜デモ用MVP構築

---

## 次回予定

### 顧客詳細ページ（設計提案中）
- 履歴タイムライン表示
- テキストメモ追加（日時付き）
- 音声入力（v2）

---

## v1.1.0 (2024-12-16)

### 変更内容
- **顧客詳細ページ (`/customers/[id]`) 完全実装**
  - 2カラムレイアウト（左: プロフィール/Pinned Note、右: タイムライン）
  - Pinned Note のアコーディオン開閉機能（チラ見せ）
  - タイムライン表示（3カラム: 日付-軸-コンテンツ）
  - 長文の「もっと見る」折りたたみ機能
  
- **レコード入力機能の拡張**
  - 記録種別選択 (MEMO / RECORD)
  - 音声入力機能 (Web Speech API)
  - **重要フラグ機能**: 「重要」「申し送り」のトグルボタンを追加、タイムライン上で強調表示

- **UI品質向上 (商用SaaS基準)**
  - `alert()` を廃止し、`sonner` による Toast 通知へ移行
  - Empty State (データなし時) のリッチ化 (アイコンとガイドテキスト)
  - マイクロインタラクション（ホバー、パルスアニメーション）の洗練

- **デモデータ拡充**
  - 読み仮名をリアルなカタカナに修正
  - タイムライン履歴を最大10件まで生成

- **顧客選択コンポーネント (`CustomerSelector`)**
  - 予約画面用の検索付き顧客選択ポップオーバーを実装

### 変更の背景
- 顧客詳細ページを「社内利用ツール」から「商用SaaSレベルのUI品質」に引き上げるため、エラーハンドリングやEmpty State、視覚的フィードバックを大幅に改善。
- 「重要フラグ」機能は、現場での情報共有（申し送り事項の視認性向上）を目的として追加。


## v1.1.1 (2025-12-16)

### 変更内容
- **不具合修正: 重要フラグ機能**
  - `addTimelineMemo` Server Action がフラグ情報 (`flags` 引数) を受け取っていなかったバグを修正。
  - タイムラインメモ作成時に「重要」「申し送り」フラグがデータベースに正しく保存されることを確認。

- **開発環境の改善**
  - **Huskyの再導入**: `.husky` フォルダと `pre-commit` フックを復元。
  - **Git Bashでのコマンド停止問題の解決**: IDE規定ターミナルをPowerShellに変更することで、AIエージェントのコマンド操作が安定化。
  - `lint-staged` によるコミット前の自動Lintチェックを有効化。

### 変更の背景
- コマンド操作が途中でフリーズする問題が開発効率を著しく下げていたため、環境設定（ターミナル）の見直しとHuskyの復旧を優先実施。
- 重要フラグ機能の検証により、UI上は選択できても保存されないバグが発覚したため緊急修正。


## v1.1.2 (2025-12-16)

### 変更内容
- **読み込み状態の最適化 (UX Improvement)**
  - `Skeleton.tsx` コンポーネントを実装。
  - 顧客詳細ページ (`/customers/[id]`) に `loading.tsx` を追加し、データ取得中のスケルトンスクリーン表示を実現。

- **AIエージェントの挙動ルールの厳格化**
  - `INIT_ROUTER.md` に「初期化完了後の強制停止プロトコル」を追加。
  - `session_handover.md` の目的定義を修正し、勝手なタスク開始を防ぐ仕組みを導入。

### 変更の背景
- データ取得時の画面のチラつき（Layout Shift）を防ぎ、SaaSとしての体感を向上させるため。
- AIエージェントが初期化直後に指示を待たず実装を開始してしまう問題への再発防止策として、ルールドキュメントを物理的な制約として機能するように修正。


## v1.2.0 (2025-12-16)

### 変更内容
- **音声入力v2 (Voice Input Enhancement)**
  - 連続音声認識モード: 話し終わっても自動で認識を再開
  - リアルタイム文字起こし: 話している途中のテキストを灰色で暫定表示
  - 録音時間カウンター: 録音中の経過時間をリアルタイム表示

- **タイムライン履歴の表示拡充**
  - 初期表示50件 + 「もっと見る」ボタンで追加読み込み
  - 表示件数のユーザー設定: 20/50/100/200件から選択可能（ローカルストレージに保存）
  - 種別フィルタ: すべて / 予約 / メモ / 記録
  - フラグフィルタ: 重要 / 申し送り
  - 削除機能: メモ・記録の削除（モーダル確認付き）

### 変更の背景
- 長文入力時の音声入力の使いやすさを向上させるため、連続認識モードを実装。
- 履歴が多い顧客の閲覧時のパフォーマンス向上と、重要な記録の絞り込み機能のため。
- 誤入力やテスト記録の削除を可能にするため、削除機能を追加（アポイントメントは予約管理側で行うため対象外）。


## v1.3.0 (2025-12-16)

### 変更内容
- **Gemini AI テキスト整形機能 (保留中 - API不安定)**
  - 音声入力したテキストをAIが自動整形
  - フィラー除去・敬語整備・文章構造の修正
  - 申し送り用要約の自動生成
  - 顧客名・来店日・要望の自動抽出

### 技術詳細
- モデル: `gemini-1.5-flash` (高速・低コスト)
- 実行環境: Server Actions (APIキー保護)
- 出力形式: JSONモード (構造化出力)

### 環境変数
```
GEMINI_API_KEY=your_api_key_here
```

---

## 次回予定

- **タイムライン詳細**: 記録の編集機能
- **検索機能**: タイムライン内のテキスト検索
- **AI機能拡張**: 過去履歴からの自動サジェスト


## v1.4.0 (2025-12-16)

### 変更内容
- **タイムライン編集機能**
  - タイムラインエントリのインライン編集機能を実装 (メモ・記録)
  - `updateTimelineEntry` Server Action を追加
  - 編集モード: テキストエリア + 保存/キャンセルボタン

- **タイムライン検索機能**
  - `loadMoreTimeline` に `query` パラメータを追加
  - テキスト検索入力フィールドを追加 (フィルタパネル内)
  - 予約のメモ、記録のSOAPフィールドを検索対象に

- **画像管理機能**
  - 画像アップロード機能 (`uploadImage` Server Action)
  - 画像表示 (タイムライン内でサムネイル表示)
  - 画像削除機能 (ファイルシステムからも削除)
  - `Attachment` テーブルとの連携

- **UIの改善**
  - タイムラインアイテムの編集・削除ボタンを「︙」メニューに統合 (視覚的な煩雑さ軽減)
  - 「フィルタ」ボタンを「検索・絞り込み」に変更 (機能の明確化)
  - タイムラインヘッダーの余白を縮小 (一覧性向上)
  - 重複していた背景アイコンを削除

- **コンポーネント追加**
  - `src/components/ui/textarea.tsx`: フォーム用テキストエリア

### 変更の背景
- 顧客詳細ページの操作性向上のため、記録の編集・削除をインラインで完結できるよう実装。
- 長期間利用時に増加する履歴データの中から特定の記録を見つけやすくするため、テキスト検索を追加。
- 施術写真や資料画像の管理ニーズに対応するため、画像アップロード機能を実装。

---

## 次回予定

- **AI機能拡張**: 過去履歴からの自動サジェスト (Gemini API安定化待ち)
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力


## v1.5.0 (2025-12-17)

### 変更内容
- **AI整形機能の安定化と出力最適化**
  - Gemini APIモデルを `gemini-flash-latest` に更新し接続を安定化
  - AI整形結果のダイアログUIをFlexboxレイアウトに変更し、長文時のスクロール切れ問題を修正
  - 記録への適用ロジック最適化: AI要約は表示のみ、実データには `formatted_text` と `extracted_data.requests` (重要事項) のみを保存

- **タイムラインエントリのフラグ編集機能**
  - 既存のタイムラインエントリ (メモ・記録) に対して、後から「重要」「申し送り」フラグを編集可能に
  - `updateTimelineEntry` Server Action を拡張し、`flags` パラメータを受け付けるように変更
  - `TimelineItem.tsx` の編集モードにフラグ切り替えボタンを追加

- **グローバルナビゲーションの刷新 (SaaS品質向上)**
  - `GlobalNavigation.tsx` クライアントコンポーネントを新規作成
  - `usePathname` で現在のページを検知し、アクティブなナビゲーション項目をハイライト表示
  - ホームページのカードアイコン (`FileText`, `Calendar`) とテーマカラー (`Indigo`, `Emerald`) を統一
  - ページ固有の冗長なヘッダー (Customer Notebook 等) を削除

- **Customer Notebook ハイブリッドナビゲーション**
  - 顧客リストの行クリックで「プレビュー」、右端の矢印アイコンで「詳細ページへ直行」を可能に

- **ホーム画面 (Dashboard) の刷新**
  - 「業務を開始するダッシュボード」コンセプトに変更
  - 「顧客登録」ボタンをヘッダー右側に主要アクションとして配置
  - カードデザインをよりコンパクト・クリーンに調整

- **顧客登録ページの刷新**
  - 2列グリッドレイアウトでフォームを整理
  - 入力フィールドのスタイルを `border-slate-300` + `focus:ring-indigo-500/20` に統一
  - アクションフッター (キャンセル/登録) を分離し、視覚的な明確さを向上

### 変更の背景
- 「スタートアップの社内ツール」ではなく「正式リリースされた商用SaaS」を想定し、全体的なUI品質を引き上げた。
- フラグ編集機能により、運用中の記録管理の柔軟性を向上。
- ハイブリッドナビゲーションにより、「ちょっと見るだけ」と「ガッツリ編集」の両方のユースケースに対応。

---

## 次回予定

- **Reservation Notebookの刷新**: Customer Notebookと同様のSaaS品質向上
- **AI機能拡張**: 過去履歴からの自動サジェスト (Gemini API安定化待ち)
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力


## v1.6.0 (2025-12-17)

### 変更内容
- **Groq Whisper 高精度音声入力統合**
  - Web Speech API を MediaRecorder + Groq `whisper-large-v3` API に置き換え
  - `transcribeAudio` Server Action を新規作成 (src/actions/groqActions.ts)
  - `MobileVoiceInput.tsx` を Groq 対応にリファクタリング
  - `CustomerDetailClient.tsx` の「記録を追加」音声入力を Groq 対応に移行
  - HTTPセキュアコンテキストチェック追加 (HTTPS/localhost以外ではマイク使用不可警告を表示)

- **PostgreSQL移行 (Neon/Vercel連携)**
  - SQLite (`file:./local.db`) から PostgreSQL (Neon) にデータベースを移行
  - `prisma/schema.prisma` の `provider` を `postgresql` に変更
  - Vercel Storage (Neon) 連携により本番環境でのDB動作を実現
  - 20名分のデモデータを本番DBに投入済み

- **Next.js CVE脆弱性対応**
  - Next.js を `16.0.8` から `16.0.10` に更新
  - React Server Components CVE (React2Shell) への対応完了

- **モバイルUI修正**
  - ハンバーガーメニューのバックドロップ透過問題を修正
  - `bg-black/20` → `bg-black/50`、`backdrop-blur-sm` → `backdrop-blur-md` に変更

- **セキュリティ強化**
  - `.gitignore` に `.env`, `.env.local`, `.env*.local` を追加
  - Git履歴からの `.env` 漏洩対応として orphan ブランチで履歴をリセット
  - Groq/Gemini APIキーの再発行・ローテーション完了

- **環境変数整理**
  - `.env` をテンプレート化 (秘密情報なし、コミット可)
  - `.env.local` に実際のキーを集約 (Gitから除外)

### 変更の背景
- Web Speech API の認識精度が低かったため、高精度なGroq Whisper APIへ移行。
- Vercel本番デプロイではSQLiteファイルアクセス不可のため、Neon PostgreSQLへ移行。
- Vercelからのセキュリティ警告 (CVE, Secrets Rotation) に即時対応。

---

## 次回予定

- **Reservation Notebookの刷新**: Customer Notebookと同様のSaaS品質向上
- **モバイル音声入力のHTTPSテスト**: Vercel本番環境でスマホからの音声入力動作確認
- **AI機能拡張**: 過去履歴からの自動サジェスト
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力


## v1.7.0 (2025-12-17)

### 変更内容
- **横断検索機能 (Global Search) 実装**
  - **検索対象の拡張**: 顧客名・電話番号だけでなく、Pinned Note、Clinical Record (Subjective, Objective, Assessment, Plan)、Memo を横断的に検索可能に
  - **ハイライト表示**: 検索ヒット箇所をプレビューし、どのフィールドでヒットしたかをアイコン付きで表示
  - **日付プレビュー**: 過去の記録がヒットした場合、日付 (`[YYYY/MM/DD]`) を先頭に表示してコンテキストを明確化 (User Feedback対応)
  - **インクリメンタル検索**: 2文字以上入力で自動検索、Debounce処理で負荷軽減

- **UI/UX 改善**
  - **Global Navigation 統合**: デスクトップ・モバイル共にヘッダー内に検索ボタンを配置
  - **検索モーダル**: `⌘K` ショートカット対応、Recent Customers（最近見た顧客）のローカル保存・表示
  - **PC版検索ボタン**: 幅を広げ視認性を向上 (`min-w-[140px]`)

- **バグ修正・技術的改善**
  - **モバイルドロワーのスタッキング問題修正**: `React Portal` を導入し、ドロワーを `body` 直下にレンダリングすることで、ヘッダーの `backdrop-filter` による透過・重なり問題を根本解決
  - **INIT_ROUTERガイドライン更新**: UI不具合修正時のプロセス（全体調査優先・試行錯誤禁止）を明文化

### 変更の背景
- 顧客情報が増えるにつれ、特定の記録（「あの時の会話」など）を探すニーズが高まったため。
- モバイルメニューの背景が透ける問題に対し、CSSのみの修正では限界があったため、アーキテクチャ（Portal）レベルで解決を行なった。

---

## 次回予定 (Priority Order)

1. **顧客サマリ（コンパクト版）**: 予約詳細から呼び出し用、0.25日
2. **モバイル顧客編集の最適化**: 必須フィールドのみの簡易モード、0.25日
3. **Empty State / Loading改善**: 一貫したUI/UX、0.25日
4. **Reservation Notebook刷新**: Customer Notebookと同等のSaaS品質へ引き上げ
5. **AI機能拡張**: 過去履歴からの自動サジェスト


## v1.8.0 (2025-12-17)

### 変更内容
- **Customer Notebook 完成度 95%達成**
  - Customer Notebook単体としての機能が概ね完成
  - モジュール設計: 顧客管理のみ利用したいユーザーに対応

- **モバイルUI/UXコンポーネント拡充**
  - `EmptyState.tsx`: テーマカラー対応 (slate/indigo/teal/amber) の空状態コンポーネント
  - `EmptyStateSearch`, `EmptyStateList`, `EmptyStateError`, `EmptyStateCustomers`, `EmptyStateReservations` プリセット
  - `Skeleton.tsx` 拡張: `SkeletonText`, `SkeletonCard`, `SkeletonList`, `SkeletonCustomerListItem`, `SkeletonTimelineItem`
  - `CustomerSummaryCard.tsx`: 予約詳細等から呼び出すコンパクト顧客情報カード
  - `QuickEditModal.tsx`: モバイル向け簡易顧客編集モーダル
  - `quickUpdatePatient` Server Action: 名前・カナ・電話のみ更新

- **Customer Notebook インクリメンタルサーチ**
  - `CustomerNotebookSearch.tsx`: 入力中に自動検索、デバウンス処理 (300ms)
  - URLパラメータ同期でブラウザバック対応

- **顧客リストUIの改善**
  - デュアルアクション: 左タップで詳細ページ、右アイコンでノート表示
  - EmptyState適用: 検索結果なし時にindigoテーマ表示

- **Reservation Notebook EmptyState適用**
  - 予約なし時にtealテーマのEmptyStateReservationsを表示
  - アクションボタン「新規予約を作成」付き

- **Prisma接続問題の解決**
  - `.env` と `.env.local` の `DATABASE_URL` 同期問題を修正
  - Neon PostgreSQLへの接続が正常に動作することを確認

### 変更の背景
- 鍼灸院からのフィードバック: 保険申請システムが別にあるため、顧客管理のみ/予約管理のみ使いたいニーズがある
- この方針に基づき、Customer Notebook と Reservation Notebook をそれぞれ単体で完成させるモジュール設計を採用
- Customer Notebook を先に完成させ、次フェーズで Reservation Notebook の刷新に着手

---

## 次回予定 (Priority Order)

1. **Reservation Notebook P0タスク**
   - チェックイン/完了ボタン (ステータス更新UI)
   - UndoToast コンポーネント
   - BottomSheet コンポーネント (予約詳細表示)

2. **Reservation Notebook 品質向上**
   - Customer Notebook と同等のSaaS品質へ引き上げ
   - モバイル最適化

3. **統合・連携機能**
   - 予約カード → 顧客詳細へのクイックナビ
   - 顧客詳細 → 予約追加ボタン
   - CustomerSummaryCard の BottomSheet 統合

4. **後回し (P2)**
   - 最近の顧客リスト
   - 二重予約警告UI
   - QuickEditModal の CustomerDetailClient 統合


---

## v1.2.0 (2025-12-17)

### 変更内容
- **Reservation Notebook 機能強化 (Phases 4-6)**
  - **日付ナビゲーション**: 前日/翌日移動、カレンダー日付指定 (`?date=YYYY-MM-DD`)
  - **表示改善**: タイムラインに詳細情報（申し送り、担当者、施術時間）を追加
  - **予約モーダル最適化**: 
    - PC: 右カラム下部にアクションボタン配置、スクロールレス化
    - Mobile: 下部固定のアクションバー
  - **確認フロー実装**:
    - バリデーション後に確認画面（Read-only）を表示
    - 完了/キャンセル確定前に `ConfirmDialog` で誤操作防止
  - **エラーハンドリング強化**: サーバー検証エラーをユーザーフレンドリーなアラートで表示

- **Bug Fixes**
  - **予約メモ自動コピー問題**: 予約メモが空の場合に患者メモが意図せず表示・保存される不具合を修正（サニタイズロジックの強化）
  - モーダル内での「処理中」ボタンの無効化処理と状態リセットの修正

### 変更の背景
- Reservation Notebook の操作性向上と誤操作防止（特にモバイル運用時）
- 意図しないデータ混入（患者のプライベートなメモが予約情報として露出するリスク）の排除

---

## v1.9.0 (2025-12-18)

### 変更内容
- **スタッフ認証機能 (Phase 7) 実装完了**
  - **認証基盤**: NextAuth.js (v5) + Credentials Provider + BCrypt
  - **ログイン画面**: `/login` ページの実装 (ID/Password認証)
  - **セッション管理**: `middleware.ts` によるルート保護、`AuthProvider` 実装
  - **ヘッダーUI**: ログイン中のスタッフ名表示、ログアウト機能
  - **DBスキーマ拡張**: `Staff` モデルに `loginId`, `passwordHash` を追加
  - **初期データ**: `prisma/seed.ts` 更新によりデモ用スタッフアカウント (admin/staff) を生成

- **モバイルUI/UX 改善**
  - **Customer Notebook 記録フォーム最適化**:
    - 音声入力FABとアクションボタンの重なり問題を解消
    - モバイル表示時のボタンレイアウトを縦並びに調整し、タップ領域を確保
    - メモ入力中はFABを自動的に隠す制御を追加

- **Vercelデプロイ**
  - `AUTH_SECRET` 環境変数の設定
  - 本番環境 (Postgres) での認証フロー動作確認完了

### 変更の背景
- **セキュリティ強化**: 誰が操作したかを特定し、不正アクセスを防ぐための基盤構築。
- **モバイルユーザビリティ**: 現場でのスマホ操作時に、ボタンが重なって押せないという致命的なUX課題を解決。

---

## v2.0.0 (2025-12-18)

### 変更内容
- **開発環境設定ファイルの再構築**
  - **3層構造への移行**: INIT_ROUTER.md + guidelines/* を Gemini.md + project-settings.md + STATUS.md に統合
  - **グローバル設定**: `~/.gemini/GEMINI.md` に全プロジェクト共通ルールを配置
  - **プロジェクト固有設定**: `.agent/rules/project-settings.md` にプロジェクト固有ルールを統合
  - **進捗管理**: `docs/STATUS.md` でセッション間の引き継ぎを管理

- **運用フローの簡素化**
  - **貼り付け作業の廃止**: Gemini.md の自動読み込みにより、セッション開始時の手動貼り付けが不要に
  - **session_handover.md 更新**: STATUS.md を上書き更新する形式に変更
  - **読み込みファイル数の削減**: 6ファイル → 3ファイル

### 変更の背景
- 初期化・引き継ぎフローの簡素化と自動化を目的とした構造改善。
- Gemini CLI / Cursor 等のAIエージェントが `.gemini/` ディレクトリを自動読み込みする仕組みを活用。

---

## v2.1.0 (2025-12-18)

### 変更内容
- **Reservation V2 新規実装 (PC最適化版)**
  - `/reservation-v2` に新規ページを作成
  - **ReservationModal**: 2カラムレイアウトの予約登録モーダル
    - 左カラム: 顧客選択、日時設定、担当者選択
    - 右カラム: 受付メモ、申し送り事項（赤背景強調）
    - 確認画面も2カラム表示に統一
  - **ひらがな検索対応**: 顧客名検索でひらがな入力をカタカナに変換してマッチング
  - **検索候補の右寄せ**: IME変換候補との重なりを回避
  - **クイックアクション**: 今日/明日/来週、+15分/+30分/+60分ボタン
  - **ReservationToolbar**: 日付ナビ、検索、フィルター、新規予約ボタン
  - **ReservationTable**: 予約一覧テーブル（ステータス、日時、顧客名、担当者、メモ、操作）
  - **SearchStatusBar**: フィルター適用状況の表示
  - **MiniCalendar**: サイドバー用カレンダー（将来用）
  - **SidebarContainer**: サイドバーコンテナ（将来用）

- **共通コンポーネント**
  - `ClientHeader.tsx`: `/reservation-v2` ではヘッダー非表示に対応
  - `useDebounce.ts`: 検索入力のデバウンス処理フック

- **ドキュメント整備**
  - `USECASES_PC_RESERVATION.md`: PC版予約管理のユースケース定義
  - `RESERVATION_FUNCTIONAL_OVERVIEW.md`: 予約システム機能概要
  - `RESERVATION_UI_RECREATION_PROMPT.md`: UI再現用プロンプト

- **コード品質**
  - 未使用インポートの削除
  - `any` 型を具体的な型に置換
  - 古い未使用関数の削除

### 変更の背景
- 既存の Reservation Notebook はモバイル向け最適化だったため、PC向けの本格的な予約管理UIを新規実装。
- 2カラムレイアウトにより、情報入力と確認がスクロールなしで完結する設計。
- ひらがな検索により、日本語入力時のIMEオン/オフを意識せずに検索可能。

### 技術的な注意点
- **ESLint `react-hooks/set-state-in-effect`**: `useEffect` 内での `setState` 呼び出しがエラーになるため、`--no-verify` でコミット。次回セッションでルールの調整またはコードのリファクタリングを検討。

---

## v2.2.0 (2025-12-18)

### 変更内容
- **Reservation V2 UI 統一仕上げ**
  - アクセントカラーを緑（Emerald）に統一
    - MiniCalendar, SidebarContainer, ReservationToolbar, ReservationModal, ReservationTable, SearchStatusBar
  - 入力フォーカス時の枠色を緑（または赤：申し送り欄）に変更
  - 検索結果ドロップダウンを右寄せレイアウトに変更（IME回避）

- **削除機能の完全実装**
  - `ConfirmDialog` を使用した削除確認モーダル
  - キャンセル済み予約のボタン無効化（グレーアウト）
  - `cancelAppointmentAction` の `revalidatePath` に `/reservation-v2` を追加

- **データ取得の統一**
  - 全期間モードでもキャンセル済み予約を表示するよう変更（`includeCancelled: true`）
  - 日付指定モードと全期間モードで削除後の挙動を統一

- **ナビゲーションのV2切り替え**
  - `GlobalNavigation.tsx`: Reservation Notebook リンクを `/reservation-v2` に変更
  - `page.tsx` (ホーム): Reservation Notebook カードを `/reservation-v2` に変更
  - V1 (`/reservation-notebook`) は残置、直接アクセスで使用可能

### 変更の背景
- UIの一貫性向上（カラーテーマの統一）によりブランド感を強化
- 削除機能をネイティブダイアログからカスタムモーダルに変更し、UX向上
- 全期間/日付指定モードでの挙動差異を解消し、ユーザー混乱を防止
- V2 を正式版として採用し、メイン導線を切り替え

---

## v2.3.0 (2025-12-18)

### 変更内容
- **RNV2 サイドバー「本日の予定」リスト実装**
  - `TodayAppointmentsList.tsx` を新規作成
  - 当日の予約をカード形式で表示
  - ステータスバッジ（予定、まもなく、対応中、終了、キャンセル）の動的表示
  - 過去の予約を薄く表示（視覚的優先度の調整）
  - リスト上部にアラートストリップ（担当未定/申し送り件数）を表示
  - カードクリックで顧客名フィルター（全期間モード）

- **UIの統一とバッジ化**
  - 「担当未定」表示を「未割り当て」バッジに変更（サイドバー・テーブル共通）
  - メモ・申し送り表示をバッジ化し、クリックでダイアログ表示に変更
  - `ReservationTable.tsx` と `TodayAppointmentsList.tsx` で統一されたモーダルロジック

- **新規コンポーネント**
  - `src/components/ui/badge.tsx`: 共通バッジコンポーネント
  - `docs/troubleshooting/DB_CONNECTION_ERRORS.md`: DB接続エラートラブルシューティング

### 変更の背景
- サイドバーに当日の予約を表示することで、画面遷移なしに予定を確認可能に
- メモの長さに左右されない一定のカード高さを実現するため、バッジ+ダイアログパターンを採用
- サイドバーとテーブルの操作感を統一し、学習コストを低減

---

## 次回予定

1. **RNV2 実装チェックリスト消化**: `docs/rnv2-checklist/RNV2_IMPLEMENTATION_CHECKLIST.md` のP1から順に
2. **申し送り解決マーク機能の実装**
3. **カレンダー選択と全期間モードの排他制御**
4. **ESLint ルール調整**: `react-hooks/set-state-in-effect` エラーの根本対応


## v2.4.0 (2025-12-19)

### 変更内容
- **JST タイムゾーン対応**
  - `date-fns-tz` パッケージを導入
  - `lib/dateUtils.ts` に `startOfDayJST`, `endOfDayJST`, `formatJST` 関数を追加
  - サーバー(UTC)とクライアント(JST)の日付境界ずれを解消
  - `appointmentServiceV2.ts` のクエリをJST基準に修正
  - 深夜0時〜9時（JST）でも正しく「今日」を判定

- **チェックイン/完了のUndoボタン実装**
  - Toast通知に「元に戻す」リンクを追加
  - チェックイン/完了の誤操作を即座に取り消し可能

- **バグ修正**
  - `cancelCheckIn` が `pending` ではなく `scheduled` を返すよう修正
  - Undo後にチェックインボタンが消える問題を解消

- **キャンセル済み予約のボタン統一**
  - テキストを削除しアイコンのみ表示
  - ボタンサイズを `p-2` に統一

- **SaaS開発ナレッジ蓄積フォルダ**
  - `docs/saas-pitfalls/` フォルダを新規作成
  - `TIMEZONE.md` にタイムゾーン問題の詳細記録

- **開発補助**
  - `prisma/seed-dec19.ts` で12月19日の様々なパターンの予約を追加

### 変更の背景
- Vercel(UTC)とブラウザ(JST)の時差により、深夜にデータ表示がずれる問題が発覚
- `date-fns-tz` で明示的にJSTを指定することで根本解決
- SaaS開発で遭遇した「落とし穴」を蓄積し、将来のプロジェクトで再発防止

---

## v2.5.0 (2025-12-19)

### 変更内容
- **コード監査レポート作成**
  - 外部CTO視点で5項目評価を実施
  - 総合スコア: 64/100点（プロトタイプ〜β版レベル）
  - 致命的問題として認証無効化、any型使用、バリデーション不足を指摘
  - `docs/CODE_AUDIT_REPORT.md` を作成

- **プロダクト戦略ドキュメント作成**
  - 「汎用コア + 業態プリセット」の分離型SaaS戦略を文書化
  - 市場ポジショニング: レッドオーシャンの隙間（月額¥2,000帯）
  - 差別化ポイント: 音声入力 + AI整形をキラー機能として定義
  - 開発フェーズ（Phase 1-3）を整理
  - `docs/design/PRODUCT_STRATEGY.md` を作成

### 変更の背景
- 商用リリースに向けた品質基準の明確化
- AI支援開発による高生産性を活かした「業態プリセット戦略」の具体化
- 鍼灸院からのフィードバック（既存システムとの共存ニーズ）を踏まえた戦略検討

---

## 次回予定

### Phase 1: 土台完成（優先度順）
1. **認証の再有効化** - middleware.ts修正、NextAuth.js再実装
2. **予約V2のスマホ対応** - テーブル → カード表示切替
3. **Zodバリデーション導入** - Server Actionsへのスキーマ適用
4. **`any`型の除去** - 12箇所の修正

### Phase 2: キラー機能磨き込み
- 音声入力の精度向上
- AI整形のプロンプト最適化（業態別）
- UXの洗練


---

## v2.6.0 (2025-12-19)

### 変更内容
- **Reservation V2 モバイル最適化**
  - **PC/モバイル完全分離**:
    - PC: 既存のテーブルレイアウト (Table)
    - Mobile: 新規カードリスト表示 (Card List)
    - 画面幅 (`md` ブレイクポイント) によるコンポーネント出し分け (`ReservationV2Client.tsx`)

  - **モバイルヘッダー刷新 (Unified Header)**:
    - 日付ナビ、検索、スタッフ選択、新規作成を1行 (高さ60px) に統合
    - 検索ボックスを主役にし、スタッフ選択を省スペースなアイコン化
    - 日付選択を `BottomSheet` に統合し、ナビゲーション（ホーム・顧客ノート）への導線を追加

  - **音声検索機能 (Mobile Voice Input)**:
    - 検索バー内にマイクボタンを配置
    - タップで音声入力モーダルが起動し、話した内容で即座に予約検索が可能

  - **インタラクティブなフィルタートグル**:
    - 「担当未定」「申し送り」の通知バッジをボタン化
    - タップで絞り込み、再タップで解除するトグル動作を実装

  - **フルスクリーン編集モーダル**:
    - モバイル時はモーダルをフルスクリーン化し、保存ボタンを下部に固定 (Sticky Footer)
    - 入力ズーム防止 (`text-base`) 対応済み

### 変更の背景
- **「現場で片手で使える」UIの実現**:
  - 従来のPC画面の縮小版ではなく、スマートフォンでの操作に特化したUIが必要だったため。
  - 「3秒で状況把握」「1タップでアクション」というモバイルファースト原則を徹底。
- **検索体験の向上**:
  - 忙しい現場で文字入力の手間を省くため、音声検索とタップでのフィルタリングを実装。

---

## 次回予定

1. **Vercel デプロイ & 動作検証**: HTTPS環境での音声入力動作確認
2. **認証機能の再有効化 (Next Priority)**
3. **Zodバリデーション導入 & `any`型除去**
