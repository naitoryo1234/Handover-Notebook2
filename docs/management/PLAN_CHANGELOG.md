# Plan Changelog

プロジェクトの計画変更・実装履歴を記録します。

---

## v1.0.0 (2024-12-16)

### 変更内容
- **Business Notebook 分離実装完了**
  - CRMから Customer Notebook / Reservation Notebook を分離
  - 共通顧客マスタ方式を採用（パターンA）
  - トップページ: 顧客一覧 + Notebook選択カード
  - Customer Notebook: 顧客検索 + Pinned Note 編集
  - Reservation Notebook: 今日の予約一覧 + CRUD
  - 顧客登録ページ: /customers/new

- **削除した機能**
  - カルテ詳細（SOAP）
  - スタッフ管理
  - 設定画面
  - 認証機能
  - CRMダッシュボード

### 変更の背景
- 「1つのCRMを再構築しない」「2つの小さな業務ツールを並べる」という方針
- 単体でも使える、必要なら連携もできる設計思想
- 土曜デモ用MVP構築

---

## 次回予定

### 顧客詳細ページ（設計提案中）
- 履歴タイムライン表示
- テキストメモ追加（日時付き）
- 音声入力（v2）

---

## v1.1.0 (2024-12-16)

### 変更内容
- **顧客詳細ページ (`/customers/[id]`) 完全実装**
  - 2カラムレイアウト（左: プロフィール/Pinned Note、右: タイムライン）
  - Pinned Note のアコーディオン開閉機能（チラ見せ）
  - タイムライン表示（3カラム: 日付-軸-コンテンツ）
  - 長文の「もっと見る」折りたたみ機能
  
- **レコード入力機能の拡張**
  - 記録種別選択 (MEMO / RECORD)
  - 音声入力機能 (Web Speech API)
  - **重要フラグ機能**: 「重要」「申し送り」のトグルボタンを追加、タイムライン上で強調表示

- **UI品質向上 (商用SaaS基準)**
  - `alert()` を廃止し、`sonner` による Toast 通知へ移行
  - Empty State (データなし時) のリッチ化 (アイコンとガイドテキスト)
  - マイクロインタラクション（ホバー、パルスアニメーション）の洗練

- **デモデータ拡充**
  - 読み仮名をリアルなカタカナに修正
  - タイムライン履歴を最大10件まで生成

- **顧客選択コンポーネント (`CustomerSelector`)**
  - 予約画面用の検索付き顧客選択ポップオーバーを実装

### 変更の背景
- 顧客詳細ページを「社内利用ツール」から「商用SaaSレベルのUI品質」に引き上げるため、エラーハンドリングやEmpty State、視覚的フィードバックを大幅に改善。
- 「重要フラグ」機能は、現場での情報共有（申し送り事項の視認性向上）を目的として追加。


## v1.1.1 (2025-12-16)

### 変更内容
- **不具合修正: 重要フラグ機能**
  - `addTimelineMemo` Server Action がフラグ情報 (`flags` 引数) を受け取っていなかったバグを修正。
  - タイムラインメモ作成時に「重要」「申し送り」フラグがデータベースに正しく保存されることを確認。

- **開発環境の改善**
  - **Huskyの再導入**: `.husky` フォルダと `pre-commit` フックを復元。
  - **Git Bashでのコマンド停止問題の解決**: IDE規定ターミナルをPowerShellに変更することで、AIエージェントのコマンド操作が安定化。
  - `lint-staged` によるコミット前の自動Lintチェックを有効化。

### 変更の背景
- コマンド操作が途中でフリーズする問題が開発効率を著しく下げていたため、環境設定（ターミナル）の見直しとHuskyの復旧を優先実施。
- 重要フラグ機能の検証により、UI上は選択できても保存されないバグが発覚したため緊急修正。


## v1.1.2 (2025-12-16)

### 変更内容
- **読み込み状態の最適化 (UX Improvement)**
  - `Skeleton.tsx` コンポーネントを実装。
  - 顧客詳細ページ (`/customers/[id]`) に `loading.tsx` を追加し、データ取得中のスケルトンスクリーン表示を実現。

- **AIエージェントの挙動ルールの厳格化**
  - `INIT_ROUTER.md` に「初期化完了後の強制停止プロトコル」を追加。
  - `session_handover.md` の目的定義を修正し、勝手なタスク開始を防ぐ仕組みを導入。

### 変更の背景
- データ取得時の画面のチラつき（Layout Shift）を防ぎ、SaaSとしての体感を向上させるため。
- AIエージェントが初期化直後に指示を待たず実装を開始してしまう問題への再発防止策として、ルールドキュメントを物理的な制約として機能するように修正。


## v1.2.0 (2025-12-16)

### 変更内容
- **音声入力v2 (Voice Input Enhancement)**
  - 連続音声認識モード: 話し終わっても自動で認識を再開
  - リアルタイム文字起こし: 話している途中のテキストを灰色で暫定表示
  - 録音時間カウンター: 録音中の経過時間をリアルタイム表示

- **タイムライン履歴の表示拡充**
  - 初期表示50件 + 「もっと見る」ボタンで追加読み込み
  - 表示件数のユーザー設定: 20/50/100/200件から選択可能（ローカルストレージに保存）
  - 種別フィルタ: すべて / 予約 / メモ / 記録
  - フラグフィルタ: 重要 / 申し送り
  - 削除機能: メモ・記録の削除（モーダル確認付き）

### 変更の背景
- 長文入力時の音声入力の使いやすさを向上させるため、連続認識モードを実装。
- 履歴が多い顧客の閲覧時のパフォーマンス向上と、重要な記録の絞り込み機能のため。
- 誤入力やテスト記録の削除を可能にするため、削除機能を追加（アポイントメントは予約管理側で行うため対象外）。


## v1.3.0 (2025-12-16)

### 変更内容
- **Gemini AI テキスト整形機能 (保留中 - API不安定)**
  - 音声入力したテキストをAIが自動整形
  - フィラー除去・敬語整備・文章構造の修正
  - 申し送り用要約の自動生成
  - 顧客名・来店日・要望の自動抽出

### 技術詳細
- モデル: `gemini-1.5-flash` (高速・低コスト)
- 実行環境: Server Actions (APIキー保護)
- 出力形式: JSONモード (構造化出力)

### 環境変数
```
GEMINI_API_KEY=your_api_key_here
```

---

## 次回予定

- **タイムライン詳細**: 記録の編集機能
- **検索機能**: タイムライン内のテキスト検索
- **AI機能拡張**: 過去履歴からの自動サジェスト


## v1.4.0 (2025-12-16)

### 変更内容
- **タイムライン編集機能**
  - タイムラインエントリのインライン編集機能を実装 (メモ・記録)
  - `updateTimelineEntry` Server Action を追加
  - 編集モード: テキストエリア + 保存/キャンセルボタン

- **タイムライン検索機能**
  - `loadMoreTimeline` に `query` パラメータを追加
  - テキスト検索入力フィールドを追加 (フィルタパネル内)
  - 予約のメモ、記録のSOAPフィールドを検索対象に

- **画像管理機能**
  - 画像アップロード機能 (`uploadImage` Server Action)
  - 画像表示 (タイムライン内でサムネイル表示)
  - 画像削除機能 (ファイルシステムからも削除)
  - `Attachment` テーブルとの連携

- **UIの改善**
  - タイムラインアイテムの編集・削除ボタンを「︙」メニューに統合 (視覚的な煩雑さ軽減)
  - 「フィルタ」ボタンを「検索・絞り込み」に変更 (機能の明確化)
  - タイムラインヘッダーの余白を縮小 (一覧性向上)
  - 重複していた背景アイコンを削除

- **コンポーネント追加**
  - `src/components/ui/textarea.tsx`: フォーム用テキストエリア

### 変更の背景
- 顧客詳細ページの操作性向上のため、記録の編集・削除をインラインで完結できるよう実装。
- 長期間利用時に増加する履歴データの中から特定の記録を見つけやすくするため、テキスト検索を追加。
- 施術写真や資料画像の管理ニーズに対応するため、画像アップロード機能を実装。

---

## 次回予定

- **AI機能拡張**: 過去履歴からの自動サジェスト (Gemini API安定化待ち)
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力


## v1.5.0 (2025-12-17)

### 変更内容
- **AI整形機能の安定化と出力最適化**
  - Gemini APIモデルを `gemini-flash-latest` に更新し接続を安定化
  - AI整形結果のダイアログUIをFlexboxレイアウトに変更し、長文時のスクロール切れ問題を修正
  - 記録への適用ロジック最適化: AI要約は表示のみ、実データには `formatted_text` と `extracted_data.requests` (重要事項) のみを保存

- **タイムラインエントリのフラグ編集機能**
  - 既存のタイムラインエントリ (メモ・記録) に対して、後から「重要」「申し送り」フラグを編集可能に
  - `updateTimelineEntry` Server Action を拡張し、`flags` パラメータを受け付けるように変更
  - `TimelineItem.tsx` の編集モードにフラグ切り替えボタンを追加

- **グローバルナビゲーションの刷新 (SaaS品質向上)**
  - `GlobalNavigation.tsx` クライアントコンポーネントを新規作成
  - `usePathname` で現在のページを検知し、アクティブなナビゲーション項目をハイライト表示
  - ホームページのカードアイコン (`FileText`, `Calendar`) とテーマカラー (`Indigo`, `Emerald`) を統一
  - ページ固有の冗長なヘッダー (Customer Notebook 等) を削除

- **Customer Notebook ハイブリッドナビゲーション**
  - 顧客リストの行クリックで「プレビュー」、右端の矢印アイコンで「詳細ページへ直行」を可能に

- **ホーム画面 (Dashboard) の刷新**
  - 「業務を開始するダッシュボード」コンセプトに変更
  - 「顧客登録」ボタンをヘッダー右側に主要アクションとして配置
  - カードデザインをよりコンパクト・クリーンに調整

- **顧客登録ページの刷新**
  - 2列グリッドレイアウトでフォームを整理
  - 入力フィールドのスタイルを `border-slate-300` + `focus:ring-indigo-500/20` に統一
  - アクションフッター (キャンセル/登録) を分離し、視覚的な明確さを向上

### 変更の背景
- 「スタートアップの社内ツール」ではなく「正式リリースされた商用SaaS」を想定し、全体的なUI品質を引き上げた。
- フラグ編集機能により、運用中の記録管理の柔軟性を向上。
- ハイブリッドナビゲーションにより、「ちょっと見るだけ」と「ガッツリ編集」の両方のユースケースに対応。

---

## 次回予定

- **Reservation Notebookの刷新**: Customer Notebookと同様のSaaS品質向上
- **AI機能拡張**: 過去履歴からの自動サジェスト (Gemini API安定化待ち)
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力


## v1.6.0 (2025-12-17)

### 変更内容
- **Groq Whisper 高精度音声入力統合**
  - Web Speech API を MediaRecorder + Groq `whisper-large-v3` API に置き換え
  - `transcribeAudio` Server Action を新規作成 (src/actions/groqActions.ts)
  - `MobileVoiceInput.tsx` を Groq 対応にリファクタリング
  - `CustomerDetailClient.tsx` の「記録を追加」音声入力を Groq 対応に移行
  - HTTPセキュアコンテキストチェック追加 (HTTPS/localhost以外ではマイク使用不可警告を表示)

- **PostgreSQL移行 (Neon/Vercel連携)**
  - SQLite (`file:./local.db`) から PostgreSQL (Neon) にデータベースを移行
  - `prisma/schema.prisma` の `provider` を `postgresql` に変更
  - Vercel Storage (Neon) 連携により本番環境でのDB動作を実現
  - 20名分のデモデータを本番DBに投入済み

- **Next.js CVE脆弱性対応**
  - Next.js を `16.0.8` から `16.0.10` に更新
  - React Server Components CVE (React2Shell) への対応完了

- **モバイルUI修正**
  - ハンバーガーメニューのバックドロップ透過問題を修正
  - `bg-black/20` → `bg-black/50`、`backdrop-blur-sm` → `backdrop-blur-md` に変更

- **セキュリティ強化**
  - `.gitignore` に `.env`, `.env.local`, `.env*.local` を追加
  - Git履歴からの `.env` 漏洩対応として orphan ブランチで履歴をリセット
  - Groq/Gemini APIキーの再発行・ローテーション完了

- **環境変数整理**
  - `.env` をテンプレート化 (秘密情報なし、コミット可)
  - `.env.local` に実際のキーを集約 (Gitから除外)

### 変更の背景
- Web Speech API の認識精度が低かったため、高精度なGroq Whisper APIへ移行。
- Vercel本番デプロイではSQLiteファイルアクセス不可のため、Neon PostgreSQLへ移行。
- Vercelからのセキュリティ警告 (CVE, Secrets Rotation) に即時対応。

---

## 次回予定

- **Reservation Notebookの刷新**: Customer Notebookと同様のSaaS品質向上
- **モバイル音声入力のHTTPSテスト**: Vercel本番環境でスマホからの音声入力動作確認
- **AI機能拡張**: 過去履歴からの自動サジェスト
- **予約連携強化**: 予約からのワンクリック記録作成
- **データエクスポート**: 顧客データのCSV/PDF出力
